# CI para .NET 9 + Docker + cobertura de cÃ³digo
name: CI

# Ejecuta el workflow en push/PR a master y main, mÃ¡s schedule semanal
on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  schedule:
    - cron: "0 6 * * 1"
  workflow_dispatch:

jobs:
  build-test:
    runs-on: ubuntu-latest
    services:
      mysql:
        image: mysql:8.4
        env:
          MYSQL_ROOT_PASSWORD: rootpass
          MYSQL_DATABASE: usersdb
          MYSQL_USER: devuser
          MYSQL_PASSWORD: devpass
        ports:
          - 3307:3306 # Expone el puerto 3306 del contenedor en el 3307 del host
        options: >-
          --health-cmd="mysqladmin ping -h localhost -prootpass" --health-interval=10s --health-timeout=5s --health-retries=10
    env:
      ConnectionStrings__Default: server=127.0.0.1;port=3307;database=usersdb;user=devuser;password=devpass;TreatTinyAsBoolean=false
      ASPNETCORE_ENVIRONMENT: Development
      AUTH_SESSION_TOKEN_MINUTES: 1440
    steps:
      - uses: actions/checkout@v4
      - name: Setup .NET 9
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "9.0.x"
          cache: true
          cache-dependency-path: |
            **/*.csproj
            **/packages.lock.json
      - name: Restore dependencies
        run: dotnet restore Users.sln
      - name: Build
        run: dotnet build Users.sln --no-restore --configuration Release
      - name: Wait for MySQL
        run: |
          for i in {1..30}; do
            if mysqladmin ping -h 127.0.0.1 -P3307 -uroot -prootpass --silent; then exit 0; fi
            sleep 2
          done
          exit 1
        shell: bash
      - name: Run tests with coverage
        run: dotnet test src/Users.Tests/Users.Tests.csproj --no-build --configuration Release --collect:"XPlat Code Coverage"
      - name: Report coverage
        uses: codecov/codecov-action@v4
        with:
          files: ./src/Users.Tests/TestResults/**/*.cobertura.xml
          fail_ci_if_error: true
          token: ${{ secrets.CODECOV_TOKEN }}

  docker-build-test:
    name: "ðŸ³ Docker Build & Smoke Test"
    runs-on: ubuntu-latest
    needs: build-test
    timeout-minutes: 15
    services:
      mysql:
        image: mysql:8.4
        env:
          MYSQL_ROOT_PASSWORD: rootpass
          MYSQL_DATABASE: usersdb
          MYSQL_USER: devuser
          MYSQL_PASSWORD: devpass
        ports:
          - 3307:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost -prootpass" --health-interval=10s --health-timeout=5s --health-retries=10
    steps:
      - uses: actions/checkout@v4
      - name: Build Docker image
        run: |
          IMAGE=ms-users-ci:${{ github.sha }}
          docker rm -f ms-users-smoke || true
          docker build -t $IMAGE .
          echo "IMAGE=$IMAGE" >> $GITHUB_ENV
      - name: Wait for MySQL
        run: |
          for i in {1..30}; do
            if mysqladmin ping -h 127.0.0.1 -P3307 -uroot -prootpass --silent; then exit 0; fi
            sleep 2
          done
          exit 1
        shell: bash
      - name: Run container
        run: |
          docker run -d --rm --name ms-users-smoke \
            -p 8081:8081 \
            -e ASPNETCORE_ENVIRONMENT=Production \
            -e ConnectionStrings__Default="server=172.17.0.1;port=3307;database=usersdb;user=devuser;password=devpass;TreatTinyAsBoolean=false" \
            "$IMAGE"
      - name: Wait for health
        shell: bash
        run: |
          for i in {1..30}; do
            if curl -fsS http://localhost:8081/health >/dev/null; then
              echo "Health is OK"; exit 0; fi;
            echo "Waiting for service... ($i/30)"; sleep 2;
          done
          if ! curl -fsS http://localhost:8081/health >/dev/null; then
            echo "Service didn't become healthy in time";
            echo "Container logs:";
            docker logs ms-users-smoke 2>&1 | tee smoke.log || true;
            exit 1;
          fi
      - name: Upload smoke logs if failed
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: ms-users-smoke-logs
          path: smoke.log
      - name: Stop container
        if: always()
        run: docker stop ms-users-smoke || true

  ci-summary:
    name: CI Summary
    runs-on: ubuntu-latest
    if: always()
    needs: [build-test, docker-build-test]
    steps:
      - name: Generate summary
        run: |
          echo "## CI Summary" >> $GITHUB_STEP_SUMMARY
          echo "- Build & Tests: ${{ needs.build-test.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- Docker Smoke: ${{ needs.docker-build-test.result }}" >> $GITHUB_STEP_SUMMARY
